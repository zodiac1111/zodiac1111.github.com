
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>lua实现简单的wireshark自定义协议解析 - 喜乐</title>
  <meta name="author" content="zodiac1111">

  
  <meta name="description" content="主要参考: 简单参考中文 http://yoursunny.com/study/IS409/ScoreBoard.htm
位操作 参考 http://blog.chinaunix.net/uid-24931444-id-3372735.html
api定义参考 http://www. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zodiac1111.github.com/blog/2012/11/11/lua-wireshark-plug-in/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="喜乐" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34836207-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText">I'm</div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">喜乐</a></h1>
  
    <h2>我的网络记事簿</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:zodiac1111.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
<li><a href="/test">Test</a></li>
<li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Lua实现简单的wireshark自定义协议解析</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-11-11T13:27:00+08:00" pubdate data-updated="true">2012-11-11 13:27</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h3>主要参考:</h3>

<ol>
<li>简单参考中文 <a href="http://yoursunny.com/study/IS409/ScoreBoard.htm">http://yoursunny.com/study/IS409/ScoreBoard.htm</a></li>
<li>位操作 参考 <a href="http://blog.chinaunix.net/uid-24931444-id-3372735.html">http://blog.chinaunix.net/uid-24931444-id-3372735.html</a></li>
<li>api定义参考 <a href="http://www.wireshark.org/docs/wsug_html_chunked/lua_module_Proto.html">http://www.wireshark.org/docs/wsug_html_chunked/lua_module_Proto.html</a></li>
</ol>


<h3>使用的功能:</h3>

<ol>
<li>按位解析 <code>f_vsq_num</code></li>
<li>分类解析  <code>if bit.rshift(bit.band(buf(4,1):uint(), 0x40), 6) == 1 then</code></li>
<li>位操作 <code>bit.rshift(bit.band(buf(4,1):uint(), 0x40), 6)</code></li>
<li>树添加 <code>local farmehead = t:add(f_farmehead,buf(0,4))</code></li>
<li>分成函数实现 <code>function FT_change_farme(buf,pkt,root) ... end</code></li>
<li>按大小端解析16位整型数据,并添加进树 <code>local addr=t:add_le(f_addr,buf(2,2))</code></li>
<li>按字节流形式添加整体和各个部分的解释 <code>ProtoField.bytes("sd102.Tb","时间(Tb)",base.HEX)</code></li>
</ol>


<h3>代码</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-- lua wireshark 山东102协议插件. file:hello.lua
</span><span class='line'>--简单参考中文 http://yoursunny.com/study/IS409/ScoreBoard.htm
</span><span class='line'>--位操作 参考 http://blog.chinaunix.net/uid-24931444-id-3372735.html
</span><span class='line'>--api定义参考 http://www.wireshark.org/docs/wsug_html_chunked/lua_module_Proto.html
</span><span class='line'>do
</span><span class='line'>  --函数前向声明
</span><span class='line'>  local FT_farme --解析单字节帧
</span><span class='line'>  local FT_static_farme --解析固定长度帧
</span><span class='line'>  local FT_change_farme --解析变长度帧
</span><span class='line'>
</span><span class='line'>  --协议名称为ScoreBoard，在Packet Details（中间可以展开的那部分）
</span><span class='line'>  --    窗格显示为山东102主站通讯规约
</span><span class='line'>  local p_ScoreBoard = Proto("sd102","山东102",base.DEC)
</span><span class='line'>  --协议的各个字段 标识符/第一字段
</span><span class='line'>  local f_identifier = ProtoField.bytes("sd102.id","标识符/规约号之类") 
</span><span class='line'>  local f_len = ProtoField.uint16("sd102.len","长度(字节)",base.DEC) 
</span><span class='line'>  --所有可能
</span><span class='line'>  local f_start = ProtoField.uint8("sd102.start","起始字节",base.HEX,
</span><span class='line'>  {[0x68]="长帧/变长帧",[0x10]="短帧/固定帧",[0xE5]="应答/单字节帧"})
</span><span class='line'>  local f_ctrl = ProtoField.uint8("sd102.ctrl","控制字节",base.HEX)
</span><span class='line'>  -- 控制端到采集终端 
</span><span class='line'>  local f_funcode = ProtoField.uint8("sd102.funcode","功能码(FC)",base.DEC,
</span><span class='line'>  {[0]="复位通信单元",[3]="传送数据",[9]="召唤链路状态",
</span><span class='line'>  [10]="召唤1级用户数据",[11]="召唤2级用户数据"},0x0F) 
</span><span class='line'>  local f_fcv = ProtoField.uint8("sd102.fcv","帧计数有效位(FCV)",base.HEX,
</span><span class='line'>  {[0]="帧计数位(FCB)的变化无效",[1]="帧计数位(FCB)的变化有效"},0x10) 
</span><span class='line'>  local f_fcb = ProtoField.uint8("sd102.fcb","帧计数位(FCB)",base.HEX,
</span><span class='line'>  {[0]="",[1]=""},0x20)
</span><span class='line'>  local f_prm= ProtoField.uint8("sd102.prm","启动报文位(PRM)",base.HEX,
</span><span class='line'>  {[0]="采集端向控制站传输",[1]="控制站向采集端传输"},0x40) 
</span><span class='line'>  --非平衡传输,根据GBT18657.2-2002 5.1.2,传输方向位保留
</span><span class='line'>  local f_dir= ProtoField.uint8("sd102.dir","备用"--[[ 传输方向位(DIR)--]],base.HEX,
</span><span class='line'>  {[0]="备用为0",[1]="备用,应为0"},0x80) 
</span><span class='line'>  -- 采集终端到控制端
</span><span class='line'>  local f_funcode_rsp = ProtoField.uint8("sd102.funcode_rsp","功能码(FC)",base.DEC,
</span><span class='line'>  {[0]="确认",[1]="链路忙,没有收到报文",[2]="备用",[3]="备用",[4]="备用",[5]="备用",
</span><span class='line'>  [6]="制造厂和用户协商定义",[7]="制造厂和用户协商定义",[8]="以数据回答请求帧",
</span><span class='line'>  [9]="没有所召唤的数据",[11]="以链路状态或访问请求回答请求帧"},0x0F) 
</span><span class='line'>  local f_dfc = ProtoField.uint8("sd102.dfc","数据流控制位(DFC)",base.HEX,
</span><span class='line'>  {[0]="终端可以接收数据",[1]="终端的缓冲区已满"},0x10) 
</span><span class='line'>  local f_acd = ProtoField.uint8("sd102.acd","要求访问位(ACD)",base.HEX,
</span><span class='line'>  {[0]="从站没有1级用户数据要求访问",[1]="从站有1级用户数据要求访问"},0x20) 
</span><span class='line'>  local f_addr= ProtoField.uint16("sd102.addr","地址(uint16)",base.DEC) 
</span><span class='line'>  local f_addr1= ProtoField.uint8("sd102.addr1","地址低字节",base.HEX) 
</span><span class='line'>  local f_addr2= ProtoField.uint8("sd102.addr2","地址高字节",base.HEX)
</span><span class='line'>  local f_p= ProtoField.uint8("sd102.p","校验和",base.HEX)
</span><span class='line'>  local f_end= ProtoField.uint8("sd102.end","结束符",base.HEX,{[0x16]="结束"})
</span><span class='line'>  --变长帧 
</span><span class='line'>  local f_farmehead=ProtoField.uint8("sd102.farmehead","帧头",base.HEX)
</span><span class='line'>  local f_ASDU=ProtoField.uint8("sd102.ASDU","应用服务数据单元",base.HEX)
</span><span class='line'>  local f_len1=ProtoField.uint8("sd102.len1","长度1",base.DEC)
</span><span class='line'>  local f_len2=ProtoField.uint8("sd102.len2","长度2",base.DEC)
</span><span class='line'>  local f_typeID_up=ProtoField.uint8("sd102.typeID2_up","类型标识(TYP)",base.DEC,
</span><span class='line'>  {[0]="未用",[1]="带时标的单点信息",[2]="读电量返回帧",[70]="初始化结束",
</span><span class='line'>  [72]="电能累计量数据终端设备的当前系统时间",
</span><span class='line'>  [128]="电能累计量数据终端系统时间同步确认",
</span><span class='line'>  [162]="读遥测量返回帧",[163]="读需量返回帧"})
</span><span class='line'>  local f_typeID_down=ProtoField.uint8("sd102.typeID2_down","类型标识(TYP)",base.DEC,
</span><span class='line'>  {[102]="读一个所选定时间范围的带时标的单点信息的记录",
</span><span class='line'>  [103]="读电能累计量数据终端设备的当前系统时间",
</span><span class='line'>  [120]="读一个选定的时间范围和一个选定的地址范围的记帐（计费）电能累计量",
</span><span class='line'>  [128]="电能累计量数据终端系统时间同步命令",
</span><span class='line'>  [172]="读一个选定的时间范围和一个选定的地址范围的遥测量",
</span><span class='line'>  [174]="读一个选定的时间范围和一个选定的地址范围的最大需量"})
</span><span class='line'>  local f_vsq=ProtoField.uint8("sd102.vsq","可变结构限定词(VSQ)",base.HEX)
</span><span class='line'>  local f_sq=ProtoField.uint8("sd102.sq","息体寻址方法(SQ)",base.HEX,
</span><span class='line'>  {[0]="每一个单个元素或综合元素由信息体地址寻址",
</span><span class='line'>  [1]="一个顺序的类似的信息元素(见IEC60870-5-3 5.1.5)"},0x80)
</span><span class='line'>  local f_vsq_num=ProtoField.uint8("sd102.vsq_num","可变结构数目",base.HEX,nil,0x7F)
</span><span class='line'>  local f_cot=ProtoField.uint8("sd102.cot","传送原因(Cause Of Transmission)",base.HEX)
</span><span class='line'>  local f_cot_t=ProtoField.uint8("sd102.cot_t","试验(Test)",base.HEX,
</span><span class='line'>  {[0]="未试验",[1]="试验"},0x80)
</span><span class='line'>  local f_cot_pn=ProtoField.uint8("sd102.cot_pn","激活确认",base.HEX,
</span><span class='line'>  {[0]="肯定确认",[1]="否定确认"},0x40)
</span><span class='line'>  local f_cot_cot=ProtoField.uint8("sd102.cot_cot","传送原因",base.DEC,
</span><span class='line'>  {[0]="未用",[1]="试验(专用范围定义)",[2]="周期、循环(专用范围定义)",
</span><span class='line'>  [3]="自发（突发）",[4]="初始化",[5]="请求或被请求",
</span><span class='line'>  [6]="激活(Act)",[7]="激活确认(actcon)",[8]="停止激活(deact)",
</span><span class='line'>  [9]="停止激活确认(deactcon)",[10]="激活终止(actterm)",
</span><span class='line'>  [11]="未用",[12]="未用",[13]="无所请求的数据记录",
</span><span class='line'>  [14]="无所请求的应用服务数据单元――类型",
</span><span class='line'>  [15]="由主站（控制站）发送的应用服务数据单元中的记录序号不可知",
</span><span class='line'>  [16]="由主站（控制站）发送的应用服务数据单元中的地址说明不可知",
</span><span class='line'>  [17]="无所请求的信息体",[18]="无所请求的累计时段",
</span><span class='line'>  [19]="为将来兼容定义保留",--[[[20-41]="未用",
</span><span class='line'>  [42-47]="为将来兼容定义保留",[48-63]="为特殊应用(专用范围)",--]]
</span><span class='line'>  [48]="时间同步(专用范围定义)"},0x3F)
</span><span class='line'>  local f_SlaveAddr=ProtoField.uint8("sd102.SlaveAddr","站地址(Addr)",base.DEC)
</span><span class='line'>  local f_recordAddr=ProtoField.uint8("sd102.recordAddr","信息体地址(IOA)",base.HEX)
</span><span class='line'>  --时间 ,其中有写位没解析 RSE
</span><span class='line'>  local f_Tb = ProtoField.bytes("sd102.Tb","时间(Tb)",base.HEX)
</span><span class='line'>  local f_Tb_ms=ProtoField.uint16("sd102.Tb_ms","毫秒(ms)",base.DEC,nil,0xFF03)
</span><span class='line'>  local f_Tb_sec=ProtoField.uint8("sd102.Tb_sec","秒(sec)",base.DEC,nil,0xFC)
</span><span class='line'>  local f_Tb_min=ProtoField.uint8("sd102.Tb_min","分钟(min)",base.DEC,nil,0x3F)
</span><span class='line'>  local f_Tb_tis=ProtoField.uint8("sd102.Tb_tis","费率陈述",base.HEX,
</span><span class='line'>  {[0]="断开OFF",[1]="合上ON"},0x40)
</span><span class='line'>  local f_Tb_iv=ProtoField.uint8("sd102.Tb_iv","时间陈述无效标志",base.HEX,
</span><span class='line'>  {[0]="有效",[1]="无效"},0x80)
</span><span class='line'>  local f_Tb_hour=ProtoField.uint8("sd102.Tb_hour","小时(hour)",base.DEC,nil,0x1F)
</span><span class='line'>  local f_Tb_day=ProtoField.uint8("sd102.Tb_day","日(day)",base.DEC,nil,0x1F)
</span><span class='line'>  local f_Tb_week=ProtoField.uint8("sd102.Tb_week","周次(week)",base.DEC,nil,0xE0)
</span><span class='line'>  local f_Tb_mon=ProtoField.uint8("sd102.Tb_mon","月(month)",base.DEC,nil,0x0F)
</span><span class='line'>  local f_Tb_year=ProtoField.uint8("sd102.Tb_year","年(year)",base.DEC,nil,0x7F)
</span><span class='line'>  local f_Tb_su=ProtoField.uint8("sd102.Tb_su","标准时间(SU)",
</span><span class='line'>  base.HEX,{[0]="标准时间",[1]="夏时制"},0x80)
</span><span class='line'>  local f_Tb_pti=ProtoField.uint8("sd102.Tb_pti","功率费率",
</span><span class='line'>  base.HEX,{[0]="功率费率"},0xC0)
</span><span class='line'>  local f_Tb_eti=ProtoField.uint8("sd102.Tb_eti","能量费率",
</span><span class='line'>  base.HEX,{[0]="能量费率"},0x30)
</span><span class='line'>  local f_msgaddr_start = ProtoField.uint8("sd102.msgaddr","起始消息体地址",base.DEC)
</span><span class='line'>  local f_msgaddr_end = ProtoField.uint8("sd102.msgaddr","终止消息体地址",base.DEC)
</span><span class='line'>  local f_msg = ProtoField.string("sd102.msg","消息")
</span><span class='line'>  --Ta
</span><span class='line'>  local f_Ta = ProtoField.bytes("sd102.Ta","时间(Ta)",base.HEX)
</span><span class='line'>  local f_Ta_min = ProtoField.uint8("sd102.Ta_min","分钟(min)",base.HEX,nil,0x3F)
</span><span class='line'>  local f_Ta_hour = ProtoField.uint8("sd102.Ta_hour","小时(hour)",base.HEX,nil,0x1F)
</span><span class='line'>  local f_Ta_day = ProtoField.uint8("sd102.Ta_day","日(day)",base.HEX,nil,0x3F)
</span><span class='line'>  local f_Ta_week = ProtoField.uint8("sd102.Ta_week","周次(week)",base.HEX,nil,0xE0)
</span><span class='line'>  local f_Ta_mon = ProtoField.uint8("sd102.Ta_mon","月(month)",base.HEX,nil,0x0F)
</span><span class='line'>  local f_Ta_year = ProtoField.uint8("sd102.Ta_year","年(year)",base.HEX,nil,0x7F)
</span><span class='line'>
</span><span class='line'>  -- 操作,第二字段
</span><span class='line'>  local f_operator = ProtoField.uint8("sd102.operator","操作",base.HEX,
</span><span class='line'>  --这个字段的数字值都有相应的含义，可以自动对应成字符串
</span><span class='line'>  { [0] = "取值", [1] = "设定值", [128] = "设定值,应答",
</span><span class='line'>  [0x10] = "取颜色", [17] = "设定颜色", [144] = "设定颜色,应答"})
</span><span class='line'>  --所有可能的字段都要定义，到时没有t:add就不会显示
</span><span class='line'>  local f_left = ProtoField.uint32("sd102.left","左边数值",base.DEC)
</span><span class='line'>  local f_right = ProtoField.uint32("sd102.right","右边数值",base.DEC)
</span><span class='line'>  local f_red = ProtoField.uint8("sd102.red","红色",base.DEC)
</span><span class='line'>  local f_green = ProtoField.uint8("sd102.green","绿色",base.DEC)
</span><span class='line'>  local f_blue = ProtoField.uint8("sd102.blue","蓝色",base.DEC)
</span><span class='line'>  local f_onebyte = ProtoField.uint8("sd102.onebyte","单字节",base.HEX)
</span><span class='line'>  p_ScoreBoard.fields = { f_identifier, f_operator, f_left, f_right, f_red, f_green,          f_blue,f_onebyte,f_len,
</span><span class='line'>  f_start,f_funcode,f_funcode_rsp,f_ctrl,
</span><span class='line'>  f_fcv,f_dfc,f_fcb,f_acd,f_prm,f_dir,f_addr,f_addr1,f_addr2,f_p,f_end,
</span><span class='line'>  f_farmehead,f_len1,f_len2,f_ASDU,f_typeID_up,f_typeID_down,f_vsq,f_sq,f_vsq_num,
</span><span class='line'>  f_cot,f_cot_t,f_cot_pn,f_cot_cot,f_SlaveAddr,f_recordAddr,
</span><span class='line'>  f_Tb,f_Tb_ms,f_Tb_sec,f_Tb_min,f_Tb_tis,f_Tb_iv,f_Tb_hour,f_Tb_day,f_Tb_week, --Tb
</span><span class='line'>  f_Tb_mon,f_Tb_year,f_Tb_su,f_Tb_pti,f_Tb_eti,
</span><span class='line'>  f_msgaddr_start,f_msgaddr_end,
</span><span class='line'>  f_Ta, f_Ta_min,f_Ta_hour,f_Ta_day,f_Ta_week,f_Ta_mon,f_Ta_year} --Ta
</span><span class='line'>
</span><span class='line'>  local data_dis = Dissector.get("data")
</span><span class='line'>  -- 函数:解码
</span><span class='line'>  local function ScoreBoard_dissector(buf,pkt,root)
</span><span class='line'>      local buf_len = buf:len();
</span><span class='line'>      if buf_len &lt; 1 then  --长度 &lt; 1 绝对错误
</span><span class='line'>          return false
</span><span class='line'>      end
</span><span class='line'>      if buf(0,1):uint() == 0xe5 then --1.单字节帧解析
</span><span class='line'>          FT_farme(buf,pkt,root)
</span><span class='line'>          return true
</span><span class='line'>      end 
</span><span class='line'>      if buf(0,1):uint() == 0x10 then --2.固定帧长帧解析
</span><span class='line'>          FT_static_farme(buf,pkt,root)
</span><span class='line'>          return true
</span><span class='line'>      end 
</span><span class='line'>      if buf(0,1):uint() == 0x68 then --3.变帧长帧解析
</span><span class='line'>          FT_change_farme(buf,pkt,root)
</span><span class='line'>          return true
</span><span class='line'>      else
</span><span class='line'>          return false
</span><span class='line'>      end 
</span><span class='line'>
</span><span class='line'>      if buf_len &lt; 17 then return false end
</span><span class='line'>      --取得前16字节identifier字段的值
</span><span class='line'>      local v_identifier = buf(0,16)
</span><span class='line'>      --验证identifier是否正确
</span><span class='line'>      if ((buf(0,1):uint()~=226) or (buf(1,1):uint()~=203) or (buf(2,1):uint()~=181)
</span><span class='line'>          or (buf(3,1):uint()~=128) or (buf(4,1):uint()~=203) or (buf(5,1):uint()~=9)
</span><span class='line'>          or (buf(6,1):uint()~=78) or (buf(7,1):uint()~=186) or (buf(8,1):uint()~=163)
</span><span class='line'>          or (buf(9,1):uint()~=107) or (buf(10,1):uint()~=246) or (buf(11,1):uint()~=7)
</span><span class='line'>          or (buf(12,1):uint()~=206) or (buf(13,1):uint()~=149) or (buf(14,1):uint()~=63)
</span><span class='line'>          or (buf(15,1):uint()~=43)) then
</span><span class='line'>          --不正确就不是我的协议  
</span><span class='line'>          return false 
</span><span class='line'>      end
</span><span class='line'>      --取得operator的值
</span><span class='line'>      local v_operator = buf(16,1)
</span><span class='line'>      local i_operator = v_operator:uint()
</span><span class='line'>
</span><span class='line'>      --现在知道是我的协议了，放心大胆添加Packet Details
</span><span class='line'>      --开始添加显示的东西
</span><span class='line'>      local t = root:add(p_ScoreBoard,buf) --添加协议
</span><span class='line'>      --在Packet List窗格的Protocol列
</span><span class='line'>      pkt.cols.protocol = "102" --显示在第一栏的协议名称
</span><span class='line'>      t:add(f_identifier,v_identifier) --域1 标识符
</span><span class='line'>      t:add(f_operator,v_operator) --域2 操作符
</span><span class='line'>      -- 域3 操作数,分三种
</span><span class='line'>      if ((i_operator == 1) or (i_operator == 128)) and (buf_len &gt;= 25) then
</span><span class='line'>          --把存在的字段逐个添加进去
</span><span class='line'>          t:add(f_left,buf(17,4))
</span><span class='line'>          t:add(f_right,buf(21,4))
</span><span class='line'>      elseif ((i_operator == 17) or (i_operator == 144)) and (buf_len &gt;= 20) then
</span><span class='line'>          t:add(f_red,buf(17,1))
</span><span class='line'>          t:add(f_green,buf(18,1))
</span><span class='line'>          t:add(f_blue,buf(19,1))
</span><span class='line'>      elseif i_operator == 0 then
</span><span class='line'>          t:add("取值操作 不需要操作数")
</span><span class='line'>      elseif i_operator == 0x10 then
</span><span class='line'>          t:add("取值颜色 不需要操作数")
</span><span class='line'>      else
</span><span class='line'>          t:add("未知的操作符!")
</span><span class='line'>      end
</span><span class='line'>
</span><span class='line'>      return true
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  -- **********解析单字节数据帧函数************
</span><span class='line'>  function FT_farme(buf,pkt,root)
</span><span class='line'>      --local p_ScoreBoard = Proto("sd102","山东102")
</span><span class='line'>      --p_ScoreBoard.fields = {f_onebyte}
</span><span class='line'>      --添加协议
</span><span class='line'>      local t = root:add(p_ScoreBoard,buf,nil,"长度=",f_len,buf:len(),"字节") 
</span><span class='line'>      pkt.cols.protocol = "sd102-单字符" --显示在第一栏的协议名称
</span><span class='line'>      t:add(f_start,buf(0,1)) 
</span><span class='line'>      --t:add("单字节数据")
</span><span class='line'>      return true
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  --************短帧/固定长帧*********
</span><span class='line'>  function FT_static_farme(buf,pkt,root)
</span><span class='line'>      local len = buf:len();
</span><span class='line'>      --添加协议
</span><span class='line'>      local t = root:add(p_ScoreBoard,buf(0,len),nil,"长度=",f_len,buf:len(),"字节") 
</span><span class='line'>      pkt.cols.protocol = "sd102-定长帧" --显示在第一栏的协议名称
</span><span class='line'>      --开始判断:
</span><span class='line'>      if len ~= 6 then --短帧的长度固定,长度不对,错误
</span><span class='line'>          t:add("len != 6 ,len=",len)
</span><span class='line'>          return false
</span><span class='line'>      end
</span><span class='line'>      if buf(5,1):uint() ~= 0x16 then --结束符错误
</span><span class='line'>          t:add("结束符!=0x16,结束符=",buf(5,1):uint())
</span><span class='line'>          return false
</span><span class='line'>      end
</span><span class='line'>      --校验和
</span><span class='line'>      --全部判断完成:
</span><span class='line'>
</span><span class='line'>      t:add(f_start,buf(0,1)) 
</span><span class='line'>      local ctrlbyte = t:add(f_ctrl,buf(1,1))
</span><span class='line'>      if bit.rshift(bit.band(buf(1,1):uint(), 0x40), 6) == 1 then --控制站向采集端
</span><span class='line'>          ctrlbyte:add(f_funcode,buf(1,1))
</span><span class='line'>          ctrlbyte:add(f_fcv,buf(1,1))
</span><span class='line'>          ctrlbyte:add(f_fcb,buf(1,1))
</span><span class='line'>          ctrlbyte:add(f_prm,buf(1,1))
</span><span class='line'>          ctrlbyte:add(f_dir,buf(1,1))
</span><span class='line'>      else --采集端 向控制端
</span><span class='line'>          ctrlbyte:add(f_funcode_rsp,buf(1,1))
</span><span class='line'>          ctrlbyte:add(f_dfc,buf(1,1))
</span><span class='line'>          ctrlbyte:add(f_acd,buf(1,1))
</span><span class='line'>          ctrlbyte:add(f_prm,buf(1,1))
</span><span class='line'>          ctrlbyte:add(f_dir,buf(1,1))
</span><span class='line'>      end
</span><span class='line'>      local addr=t:add_le(f_addr,buf(2,2)) 
</span><span class='line'>      addr:add(f_addr1,buf(2,1)) 
</span><span class='line'>      addr:add(f_addr2,buf(3,1))
</span><span class='line'>      t:add(f_p,buf(4,1)) 
</span><span class='line'>      t:add(f_end,buf(5,1)) 
</span><span class='line'>      --t:add("单字节数据") 
</span><span class='line'>      return true
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  --**********长帧/变长帧**************
</span><span class='line'>  function FT_change_farme(buf,pkt,root)
</span><span class='line'>      local len = buf:len();
</span><span class='line'>      --添加协议
</span><span class='line'>      local t = root:add(p_ScoreBoard,buf(0,len),nil,"长度=",f_len,buf:len(),"字节") 
</span><span class='line'>      pkt.cols.protocol = "sd102-变长帧" --显示在第一栏的协议名称
</span><span class='line'>      --开始判断:
</span><span class='line'>      if len &lt; 6 then --长度太小错误
</span><span class='line'>          t:add("长度太小:",len)
</span><span class='line'>          return false
</span><span class='line'>      end
</span><span class='line'>      if buf(3,1):uint() ~= 0x68 then --帧边界 两个0x68
</span><span class='line'>          t:add("边界不等于0x68",buf(3,1):uint())
</span><span class='line'>          return false
</span><span class='line'>      end
</span><span class='line'>      if buf(1,1):uint() ~= buf(2,1):uint() then --两个长度必须相同
</span><span class='line'>          t:add("长度不等",buf(1,1):uint(),buf(2,1):uint())
</span><span class='line'>          return false
</span><span class='line'>      end
</span><span class='line'>      if buf(len-1,1):uint() ~= 0x16 then --结束符错误
</span><span class='line'>          return false
</span><span class='line'>      end
</span><span class='line'>      --全部判断完成:
</span><span class='line'>      t:add(f_start,buf(0,1)) 
</span><span class='line'>      local farmehead = t:add(f_farmehead,buf(0,4))
</span><span class='line'>      farmehead:add(f_start,buf(0,1))
</span><span class='line'>      farmehead:add(f_len1,buf(1,1))
</span><span class='line'>      farmehead:add(f_len2,buf(2,1))
</span><span class='line'>      farmehead:add(f_start,buf(3,1))
</span><span class='line'>      local ctrlbyte = t:add(f_ctrl,buf(4,1))
</span><span class='line'>      if bit.rshift(bit.band(buf(4,1):uint(), 0x40), 6) == 1 then --控制站向采集端
</span><span class='line'>          ctrlbyte:add(f_funcode,buf(4,1))
</span><span class='line'>          ctrlbyte:add(f_fcv,buf(4,1))
</span><span class='line'>          ctrlbyte:add(f_fcb,buf(4,1))
</span><span class='line'>          ctrlbyte:add(f_prm,buf(4,1))
</span><span class='line'>          ctrlbyte:add(f_dir,buf(4,1))
</span><span class='line'>      else --采集端 向控制端
</span><span class='line'>          ctrlbyte:add(f_funcode_rsp,buf(4,1))
</span><span class='line'>          ctrlbyte:add(f_dfc,buf(4,1))
</span><span class='line'>          ctrlbyte:add(f_acd,buf(4,1))
</span><span class='line'>          ctrlbyte:add(f_prm,buf(4,1))
</span><span class='line'>          ctrlbyte:add(f_dir,buf(1,1))
</span><span class='line'>      end
</span><span class='line'>      t:add(f_addr1,buf(5,1)) 
</span><span class='line'>      t:add(f_addr2,buf(6,1))
</span><span class='line'>      if bit.rshift(bit.band(buf(4,1):uint(), 0x40), 6) == 1 then --控制站向采集端
</span><span class='line'>          t:add(f_typeID_down,buf(7,1))
</span><span class='line'>      else --采集端 向控制端
</span><span class='line'>          t:add(f_typeID_up,buf(7,1))
</span><span class='line'>      end
</span><span class='line'>      local vsq = t:add(f_vsq,buf(8,1))
</span><span class='line'>      vsq:add(f_sq,buf(8,1))
</span><span class='line'>      vsq:add(f_vsq_num,buf(8,1))
</span><span class='line'>      local cot = t:add(f_cot,buf(9,1))
</span><span class='line'>      cot:add(f_cot_t,buf(9,1))
</span><span class='line'>      cot:add(f_cot_pn,buf(9,1))
</span><span class='line'>      cot:add(f_cot_cot,buf(9,1))
</span><span class='line'>      t:add(f_SlaveAddr,buf(10,2))
</span><span class='line'>      t:add(f_recordAddr,buf(12,1))
</span><span class='line'>      --按上下行分类
</span><span class='line'>      if bit.rshift(bit.band(buf(4,1):uint(), 0x40), 6) == 1 then --下行
</span><span class='line'>          --按TYP分类
</span><span class='line'>          if buf(7,1):uint() == 103 then --读终端时间,
</span><span class='line'>              --什么都不做,信息体为空
</span><span class='line'>          elseif buf(7,1):uint() == 128 then --设置终端时间
</span><span class='line'>              local Tb = t:add(f_Tb,buf(13,7))            
</span><span class='line'>              Tb:add(f_Tb_ms,buf(13,2))
</span><span class='line'>              Tb:add(f_Tb_sec,buf(14,1))
</span><span class='line'>              Tb:add(f_Tb_min,buf(15,1))
</span><span class='line'>              Tb:add(f_Tb_tis,buf(15,1))
</span><span class='line'>              Tb:add(f_Tb_iv,buf(15,1))
</span><span class='line'>              Tb:add(f_Tb_hour,buf(16,1))
</span><span class='line'>              Tb:add(f_Tb_su,buf(16,1))
</span><span class='line'>              Tb:add(f_Tb_day,buf(17,1))
</span><span class='line'>              Tb:add(f_Tb_week,buf(17,1))
</span><span class='line'>              Tb:add(f_Tb_mon,buf(18,1))
</span><span class='line'>              Tb:add(f_Tb_pti,buf(18,1))
</span><span class='line'>              Tb:add(f_Tb_eti,buf(18,1))
</span><span class='line'>              Tb:add(f_Tb_year,buf(19,1))
</span><span class='line'>              --读一个选定的时间范围和一个选定的地址范围的记帐（计费）电能累计量
</span><span class='line'>          elseif buf(7,1):uint() == 120 then 
</span><span class='line'>              t:add(f_msgaddr_start,buf(13,1))
</span><span class='line'>              t:add(f_msgaddr_end,buf(14,1))
</span><span class='line'>              local Ta_start = t:add(f_Ta,buf(15,5))
</span><span class='line'>              Ta_start:add(f_Ta_year,buf(19,1))
</span><span class='line'>              Ta_start:add(f_Ta_mon,buf(18,1))
</span><span class='line'>              Ta_start:add(f_Ta_day,buf(17,1))
</span><span class='line'>              Ta_start:add(f_Ta_hour,buf(16,1))
</span><span class='line'>              Ta_start:add(f_Ta_min,buf(15,1))
</span><span class='line'>              Ta_start:add(f_Ta_week,buf(17,1))
</span><span class='line'>              local Ta_end = t:add(f_Ta,buf(20,5))
</span><span class='line'>              Ta_end:add(f_Ta_year,buf(24,1))
</span><span class='line'>              Ta_end:add(f_Ta_mon,buf(23,1))
</span><span class='line'>              Ta_end:add(f_Ta_day,buf(22,1))
</span><span class='line'>              Ta_end:add(f_Ta_hour,buf(21,1))
</span><span class='line'>              Ta_end:add(f_Ta_min,buf(20,1))
</span><span class='line'>              Ta_end:add(f_Ta_week,buf(22,1))
</span><span class='line'>          end
</span><span class='line'>      else --上行 
</span><span class='line'>          if buf(7,1):uint() == 72 then --返回当前系统时间
</span><span class='line'>              local Tb = t:add(f_Tb,buf(13,7))            
</span><span class='line'>              Tb:add(f_Tb_ms,buf(13,2))
</span><span class='line'>              Tb:add(f_Tb_sec,buf(14,1))
</span><span class='line'>              Tb:add(f_Tb_min,buf(15,1))
</span><span class='line'>              Tb:add(f_Tb_tis,buf(15,1))
</span><span class='line'>              Tb:add(f_Tb_iv,buf(15,1))
</span><span class='line'>              Tb:add(f_Tb_hour,buf(16,1))
</span><span class='line'>              Tb:add(f_Tb_su,buf(16,1))
</span><span class='line'>              Tb:add(f_Tb_day,buf(17,1))
</span><span class='line'>              Tb:add(f_Tb_week,buf(17,1))
</span><span class='line'>              Tb:add(f_Tb_mon,buf(18,1))
</span><span class='line'>              Tb:add(f_Tb_pti,buf(18,1))
</span><span class='line'>              Tb:add(f_Tb_eti,buf(18,1))
</span><span class='line'>              Tb:add(f_Tb_year,buf(19,1))
</span><span class='line'>              --Tb:add("上行,72")
</span><span class='line'>          elseif buf(7,1):uint() == 128 then --电能累计量数据终端系统时间同步确认
</span><span class='line'>              local Tb = t:add(f_Tb,buf(13,7))            
</span><span class='line'>              Tb:add(f_Tb_ms,buf(13,2))
</span><span class='line'>              Tb:add(f_Tb_sec,buf(14,1))
</span><span class='line'>              Tb:add(f_Tb_min,buf(15,1))
</span><span class='line'>              Tb:add(f_Tb_tis,buf(15,1))
</span><span class='line'>              Tb:add(f_Tb_iv,buf(15,1))
</span><span class='line'>              Tb:add(f_Tb_hour,buf(16,1))
</span><span class='line'>              Tb:add(f_Tb_su,buf(16,1))
</span><span class='line'>              Tb:add(f_Tb_day,buf(17,1))
</span><span class='line'>              Tb:add(f_Tb_week,buf(17,1))
</span><span class='line'>              Tb:add(f_Tb_mon,buf(18,1))
</span><span class='line'>              Tb:add(f_Tb_pti,buf(18,1))
</span><span class='line'>              Tb:add(f_Tb_eti,buf(18,1))
</span><span class='line'>              Tb:add(f_Tb_year,buf(19,1))
</span><span class='line'>          end
</span><span class='line'>      end
</span><span class='line'>      -- 结束
</span><span class='line'>      t:add(f_p,buf(len-2,1))
</span><span class='line'>      t:add(f_end,buf(len-1,1))
</span><span class='line'>      return true
</span><span class='line'>  end
</span><span class='line'>  -- 全局函数?api?
</span><span class='line'>  function p_ScoreBoard.dissector(buf,pkt,root) 
</span><span class='line'>      if ScoreBoard_dissector(buf,pkt,root) then
</span><span class='line'>          --valid ScoreBoard diagram
</span><span class='line'>      else
</span><span class='line'>          --data这个dissector几乎是必不可少的；当发现不是我的协议时，就应该调用data
</span><span class='line'>          data_dis:call(buf,pkt,root)
</span><span class='line'>      end
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  local tcp_encap_table = DissectorTable.get("tcp.port")
</span><span class='line'>  --只需要处理UDP1127端口就可以了
</span><span class='line'>  tcp_encap_table:add(10003,p_ScoreBoard)
</span><span class='line'>  tcp_encap_table:add(10004,p_ScoreBoard)
</span><span class='line'>  tcp_encap_table:add(10005,p_ScoreBoard)
</span><span class='line'>  tcp_encap_table:add(35243,p_ScoreBoard)
</span><span class='line'>  tcp_encap_table:add(50187,p_ScoreBoard)
</span><span class='line'>  --udp_encap_table:add(10003,p_ScoreBoard)
</span><span class='line'>  --udp_encap_table:add(10001,p_ScoreBoard)
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">zodiac1111</span></span>

      








  


<time datetime="2012-11-11T13:27:00+08:00" pubdate data-updated="true">2012-11-11 13:27</time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/blog/2012/09/29/build-goldendict-from-source/" title="Previous Post: 编译 goldendict 笔记">&laquo; 编译 goldendict 笔记</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/11/11/lua-wireshark-plug-in/">lua实现简单的wireshark自定义协议解析</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/29/build-goldendict-from-source/">编译 goldendict 笔记</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/20/otcopress-githubrepowidget/">使用 githubRepoWidget 展示 github 项目</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/20/online-ieee-754-analysis-binary-decimal-converter/">在线分析转换标准 float 型数据</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/20/chromium-pdf-viewer/">chromium 预览 pdf 文件</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/19/rake-completion-in-bash/">rake 自动补全 task</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/17/linux-fedora-17-install-nfs-server/">Linux/Fedora 17下安装配置NFS服务</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/zodiac1111">@zodiac1111</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'zodiac1111',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("zodiac_2012", 0, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <p>Follow <a href="http://twitter.com/zodiac_2012">@zodiac_2012</a></p>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - zodiac1111 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Theme <a href="https://github.com/amelandri/darkstripes">DarkStripes</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'zodiac1111blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://zodiac1111.github.com/blog/2012/11/11/lua-wireshark-plug-in/';
        var disqus_url = 'http://zodiac1111.github.com/blog/2012/11/11/lua-wireshark-plug-in/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
